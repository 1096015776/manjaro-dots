function getPreview(a){return new Promise(b=>{const c=new Image;return a?void(c.src="https://mini.s-shot.ru/1366x890/400/jpeg/?"+a,c.onload=()=>{const a=document.createElement("canvas");a.width=c.width,a.height=c.height;const d=a.getContext("2d");d.drawImage(c,0,0,a.width,a.height);const e=a.toDataURL("image/jpeg");b(e)},c.onerror=()=>b(null)):b(null)})}function initBookmarks(a){chrome.topSites.get(b=>{let c=b.filter(a=>"chrome"!==a.url.slice(0,6)&&!a.url.includes("localhost")).slice(0,10).map((a,b)=>({id:b,url:a.url,title:a.title||"",img:""}));chrome.storage.local.set({bookmarks:c});const d=c.map(a=>getPreview(a.url));Promise.all(d).then(d=>{c=c.map((a,b)=>(a.img=d[b],a)),chrome.storage.local.set({bookmarks:c}),chrome.runtime.sendMessage({action:"reload-storage"}),a&&a()})})}chrome.runtime.setUninstallURL("https://infinitetab.com/uninstall.html",()=>{}),chrome.browserAction.onClicked.addListener(()=>chrome.tabs.create({})),chrome.runtime.onInstalled.addListener(a=>{"install"===a.reason&&(initSettings(),initBookmarks(()=>{chrome.tabs.query({},function(a){for(let b=0;b<a.length;b++)matchUrl(a[b].url)&&(chrome.tabs.executeScript(a[b].id,{file:"./js/content.js"},function(){const c=chrome.runtime.lastError;c&&console.log("tab: "+a[b].id+" lastError: "+JSON.stringify(c))}),chrome.tabs.insertCSS(a[b].id,{file:"./css/content.css"},function(){const c=chrome.runtime.lastError;c&&console.log("tab: "+a[b].id+" lastError: "+JSON.stringify(c))}))})}),chrome.tabs.create({url:"https://infinitetab.com/install.html",active:!0}))}),chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"newtab_utilsExtDownloadMenuItem",title:"Pin "+chrome.i18n.getMessage("name"),contexts:["page","link"],onclick:function(a,b){if(a.pageUrl.includes("chrome-extension")||a.pageUrl.includes("chrome://"))return!1;if(a.linkUrl){const b=a.linkUrl,c=encodeURIComponent(b);chrome.tabs.create({url:"/newtab.html?url="+c,active:!0})}else if(a.pageUrl){const c=a.pageUrl,d=b.title,e=encodeURIComponent(c);chrome.tabs.create({url:"/newtab.html?url="+e+"&title="+d,active:!0})}}})}),chrome.runtime.onMessage.addListener(a=>{if("create-window"===a.action){const b=a.width||1e3,c=a.height||800;chrome.windows.create({type:"popup",url:a.url,width:b,height:c,left:screen.width/2-b/2})}"refresh-sidebar"==a.action&&chrome.tabs.query({},a=>{a.forEach(a=>{chrome.tabs.sendMessage(a.id,{action:"update-sidebar"})})})});function matchUrl(a){return!a.match("https://chrome.google.com")&&!a.match("view-source:")&&!a.match("file:///")&&(!!a.match("http://")||!!a.match("https://")||void 0)}function initSettings(){chrome.storage.local.set({showSidebar:!0})}